<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GS1 Smart Manager</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bwip-js/3.0.4/bwip-js-min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #ecf0f1; display: flex; flex-direction: column; height: 100vh; }
        header { background: #2c3e50; color: white; padding: 15px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        
        .content { flex: 1; overflow-y: auto; padding: 15px; }
        .panel { display: none; }
        .panel.active { display: block; animation: slideIn 0.3s; }
        
        /* K√°rtya st√≠lus */
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        /* Inputok */
        label { font-size: 0.85rem; color: #7f8c8d; font-weight: bold; text-transform: uppercase; margin-top: 10px; display: block; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #bdc3c7; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        /* Gombok */
        .btn-action { width: 100%; padding: 14px; background: #27ae60; color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; margin-top: 15px; cursor: pointer; }
        .btn-save { background: #2980b9; }
        
        /* Navig√°ci√≥ */
        nav { background: white; display: flex; border-top: 1px solid #ddd; height: 60px; }
        nav button { flex: 1; border: none; background: transparent; font-size: 0.9rem; color: #95a5a6; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        nav button.active { color: #2c3e50; font-weight: bold; border-top: 3px solid #2c3e50; }

        /* Vizu√°lis elemek */
        #gtin-preview { font-family: monospace; font-size: 1.2rem; letter-spacing: 2px; text-align: center; margin: 10px 0; color: #34495e; font-weight: bold; }
        .gtin-part-prefix { color: #e67e22; } /* Gy√°rt√≥ */
        .gtin-part-item { color: #2980b9; }   /* T√°rgy */
        .gtin-part-check { color: #c0392b; }  /* Checksum */

        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<header>
    <h1>GS1 Okos Rakt√°r</h1>
</header>

<div class="content">
    
    <div id="view-scan" class="panel active">
        <div id="reader" style="border-radius:10px; overflow:hidden;"></div>
        
        <div id="scan-result" class="card" style="display:none; margin-top:15px; border-left: 5px solid #27ae60;">
            <h2 id="res-name" style="margin:0; color: #2c3e50;">Ismeretlen Term√©k</h2>
            <p id="res-maker" style="margin:5px 0; color: #7f8c8d;">Gy√°rt√≥: -</p>
            <hr style="border:0; border-top:1px solid #eee;">
            <div style="font-size: 0.9rem;">
                <strong>GTIN:</strong> <span id="res-gtin"></span><br>
                <strong>Lej√°rat:</strong> <span id="res-exp">-</span><br>
                <strong>Batch:</strong> <span id="res-batch">-</span>
            </div>
        </div>
    </div>

    <div id="view-edit" class="panel">
        <div class="card">
            <h3>√öj term√©k / C√≠mke tervez√©se</h3>
            
            <label>Term√©k Neve</label>
            <input type="text" id="inp-name" placeholder="pl. Pr√©mium √Åsv√°nyv√≠z 1.5L" oninput="saveToTemp()">

            <label>Gy√°rt√≥ Neve</label>
            <input type="text" id="inp-maker" placeholder="pl. Aqua Kft." oninput="saveToTemp()">

            <hr>

            <label>GTIN √ñssze√°ll√≠t√°sa</label>
            <div class="row">
                <div class="col" style="flex:2">
                    <input type="text" id="inp-prefix" placeholder="Orsz√°g+C√©g (pl. 599123)" maxlength="9" oninput="updateGtinPreview()">
                    <span style="font-size:0.7rem; color:#e67e22">C√©g prefix</span>
                </div>
                <div class="col" style="flex:2">
                    <input type="text" id="inp-item" placeholder="Sorsz√°m" maxlength="6" oninput="updateGtinPreview()">
                    <span style="font-size:0.7rem; color:#2980b9">Term√©k k√≥d</span>
                </div>
            </div>
            
            <div id="gtin-preview">
                <span class="gtin-part-prefix">000000</span><span class="gtin-part-item">00000</span><span class="gtin-part-check">0</span>
            </div>

            <label>V√°ltoz√≥ Adatok</label>
            <div class="row">
                <div class="col">
                    <input type="text" id="inp-exp" placeholder="YYMMDD" value="251231">
                </div>
                <div class="col">
                    <input type="text" id="inp-batch" placeholder="Batch ID" value="LOT01">
                </div>
            </div>

            <button class="btn-action btn-save" onclick="saveProduct()">üíæ Term√©k Ment√©se</button>
            <button class="btn-action" onclick="generateBarcode()">‚öôÔ∏è Vonalk√≥d Gener√°l√°sa</button>
        </div>

        <div class="card" style="text-align:center;">
            <canvas id="barcodeCanvas"></canvas>
            <p style="font-size:0.8rem; color:#999;">Hossz√∫ nyom√°ssal menthet≈ë a k√©p</p>
        </div>
    </div>
</div>

<nav>
    <button id="nav-scan" class="active" onclick="setView('scan')">üì∑ Szkennel√©s</button>
    <button id="nav-edit" onclick="setView('edit')">üìù Szerkeszt≈ë</button>
</nav>

<script>
    // --- ADATB√ÅZIS KEZEL√âS (LocalStorage) ---
    // Bet√∂ltj√ºk a mentett term√©keket a telefon mem√≥ri√°j√°b√≥l
    function getDb() {
        return JSON.parse(localStorage.getItem('gs1_products') || '{}');
    }

    function saveProduct() {
        const db = getDb();
        const fullGtin = document.getElementById('gtin-preview').innerText;
        const name = document.getElementById('inp-name').value;
        const maker = document.getElementById('inp-maker').value;

        if(!name || fullGtin.length < 13) {
            alert("K√©rlek t√∂ltsd ki a nevet √©s a GTIN mez≈ëket!");
            return;
        }

        // Kulcs-√©rt√©k p√°r ment√©se: GTIN -> Adatok
        db[fullGtin] = { name: name, maker: maker };
        localStorage.setItem('gs1_products', JSON.stringify(db));
        alert(`Term√©k elmentve!\nGTIN: ${fullGtin}\nN√©v: ${name}`);
    }

    // --- GTIN LOGIKA ---
    function calculateCheckDigit(gtinWithoutCheck) {
        // GS1 Modulo 10 sz√°m√≠t√°s
        let sum = 0;
        let reversed = gtinWithoutCheck.split('').reverse().join('');
        for (let i = 0; i < reversed.length; i++) {
            sum += parseInt(reversed[i]) * (i % 2 === 0 ? 3 : 1);
        }
        let ceil = Math.ceil(sum / 10) * 10;
        return ceil - sum;
    }

    function updateGtinPreview() {
        let prefix = document.getElementById('inp-prefix').value || "0";
        let item = document.getElementById('inp-item').value || "0";
        
        // √ñsszerakjuk, hogy 13 karakter legyen (GTIN-13/14 alap)
        // √Åltal√°ban: Prefix + Item = 13 karakter, a 14. a Checksum
        // Egyszer≈±s√≠t√©s: Felt√©telezz√ºk a GTIN-13 form√°tumot + Check digit
        
        let combined = prefix + item;
        // P√°rn√°z√°s, hogy meglegyen a hossza (kiv√©ve check digit)
        while(combined.length < 13) { combined += "0"; } 
        combined = combined.substring(0, 13); // Max hossz v√°g√°sa

        const checkDigit = calculateCheckDigit(combined);
        
        // HTML sz√≠nez√©s
        const html = `
            <span class="gtin-part-prefix">${prefix}</span>
            <span class="gtin-part-item">${combined.substring(prefix.length)}</span>
            <span class="gtin-part-check">${checkDigit}</span>
        `;
        document.getElementById('gtin-preview').innerHTML = html;
        document.getElementById('gtin-preview').dataset.raw = combined + checkDigit;
    }

    // --- GENER√ÅL√ÅS ---
    function generateBarcode() {
        const gtin = document.getElementById('gtin-preview').innerText; // A teljes sz√°m
        const exp = document.getElementById('inp-exp').value;
        const batch = document.getElementById('inp-batch').value;

        // GS1-128 form√°tum √∂ssze√°ll√≠t√°sa
        // (01)GTIN + (17)Exp + (10)Batch
        // FNC1 karakter kezel√©s√©t a bwip-js v√©gzi
        let txt = `(01)${gtin}`;
        if(exp) txt += `(17)${exp}`;
        if(batch) txt += `(10)${batch}`;

        try {
            bwipjs.toCanvas('barcodeCanvas', {
                bcid: 'gs1-128',
                text: txt,
                scale: 3,
                height: 10,
                includetext: true,
                textxalign: 'center',
            });
        } catch(e) { alert(e); }
    }

    // --- OLVAS√ÅS √âS FELISMER√âS ---
    let scanner = null;
    function startScan() {
        if(!scanner) scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
            handleScannedData(decodedText);
        });
    }

    function handleScannedData(text) {
        // 1. Megpr√≥b√°ljuk kinyerni a GTIN-t a sz√∂vegb≈ël
        // A GS1 k√≥dok gyakran √≠gy j√∂nnek: ]C1010599123...17...
        // Vagy sim√°n: 0105991234567890...
        
        let foundGtin = "";
        let foundExp = "-";
        let foundBatch = "-";
        
        // Egyszer≈± "Brute force" parser a GTIN (01) megtal√°l√°s√°ra
        // Ez a regex a (01) ut√°ni 14 sz√°mjegyet keresi
        const gtinRegex = /(?:01)(\d{14})/;
        const match = text.match(gtinRegex);
        
        if (match) {
            foundGtin = match[1]; // A 14 jegy≈± sz√°m
            
            // Ha megvan a GTIN, keress√ºk meg az adatb√°zisban!
            const db = getDb();
            // A GTIN-14 gyakran vezet≈ë null√°val t√©r el a 13-ast√≥l, ezt kezelni kell
            // Lev√°gjuk az els≈ë null√°t az √∂sszehasonl√≠t√°shoz, ha sz√ºks√©ges
            let lookupGtin = foundGtin; 
            if (lookupGtin.startsWith('0')) lookupGtin = lookupGtin.substring(1); 
            
            // Pr√≥b√°lkozunk √≠gy is, √∫gy is
            let product = db[foundGtin] || db[lookupGtin]; 

            const resDiv = document.getElementById('scan-result');
            const nameEl = document.getElementById('res-name');
            const makerEl = document.getElementById('res-maker');

            resDiv.style.display = 'block';
            
            if (product) {
                nameEl.innerText = product.name;
                nameEl.style.color = "#27ae60"; // Z√∂ld, ha tal√°ltunk
                makerEl.innerText = "Gy√°rt√≥: " + product.maker;
            } else {
                nameEl.innerText = "Ismeretlen Term√©k";
                nameEl.style.color = "#c0392b"; // Piros, ha nem
                makerEl.innerText = "Nincs az adatb√°zisban";
            }
            
            document.getElementById('res-gtin').innerText = foundGtin;
            
            // Egy√©b AI-k keres√©se (d√°tum, batch) demo jelleggel
            if(text.includes("17")) foundExp = "D√°tum adat √©szlelve";
            if(text.includes("10")) foundBatch = "Batch adat √©szlelve";
            
            document.getElementById('res-exp').innerText = foundExp;
            document.getElementById('res-batch').innerText = foundBatch;
        }
    }

    // --- APP VEZ√âRL√âS ---
    function setView(view) {
        document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        document.getElementById('nav-' + view).classList.add('active');

        if(view === 'scan') startScan();
        else if(scanner) scanner.stop().catch(()=>{});
    }
    
    // Alap√©rtelmezett h√≠v√°sok
    updateGtinPreview();
</script>
</body>
</html>
